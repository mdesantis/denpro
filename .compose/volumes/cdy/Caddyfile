{
	auto_https off
	http_port 8080

	log {
		format console
		level debug
	}
}

http://localhost, http://localhost.localdomain, http://*.localhost, http://*.localhost.localdomain {
	log
	root * /srv/public
	file_server
	encode zstd gzip

	@static file
	@notStatic not file

	header @static Cache-Control "public, max-age=31556952"

	reverse_proxy @notStatic rls:3000 {
		header_up X-Sendfile-Type "X-Sendfile"

		@sendfile header X-Sendfile *

		handle_response @sendfile {
			root * /srv/storage
			# rewrite * {rp.header.X-Sendfile}
			log_append upstream_sendfile {rp.header.X-Sendfile}
			rewrite * /rails/storage/h5/3n/h53n3t9isw5r00y8uvfjm70o57j6
			uri * strip_prefix /rails/storage
			method * GET
			file_server
		}

		@err status 400 404 422 500

		handle_response @err {
			error "" {rp.status_code}
		}
	}

	handle_errors 400 404 422 500 {
		root * /srv/public
		rewrite * /{err.status_code}.html
		file_server
	}
}

#handle_response @sendfile {
#root * /srv/private
#rewrite {http.response.header.X-Sendfile}
#file_server
#}
#handle_response @sendfile {
#rewrite {http.response.header.X-Sendfile}
#copy_response

#root * /srv/private

#header X-Sendfile /rails/storage ""
# rewrite /nm/7b/nm7bj8axe6ozeqo5m4j7ojuqs48a

#file_server

#copy_response_headers
#respond "test"
#}


# @accel header X-Accel-Redirect *
# handle_response @accel {
# 	root * /path/to/private/files
# 	rewrite {http.response.header.X-Accel-Redirect}
# 	file_server
# }
# }
